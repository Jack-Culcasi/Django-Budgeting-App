{% extends "index.html" %}
{% block start %}
{% load humanize %}
{% if payday_exists %}
{% else %}
<ul class="steps">
  <li class="step {% if steps_completed.account_created %}step-primary{% endif %}">Account created</li>
  <li class="step {% if steps_completed.add_bank %}step-primary{% endif %}">Add a Bank</li>
  <li class="step {% if steps_completed.add_broker %}step-primary{% endif %}">Add a Broker</li>
  <li class="step {% if steps_completed.add_fixed_cost %}step-primary{% endif %}">Add a Fixed Cost</li>
  <li class="step {% if steps_completed.add_investment %}step-primary{% endif %}">Add an Investment</li>
  <li class="step {% if steps_completed.add_categories %}step-primary{% endif %}">Add categories</li>
  {% if  steps_completed.add_categories and steps_completed.add_investment %}
  <li class="step">
    <a href="{% url 'payday' %}" class="btn btn-primary">Add your first payday!</a>
  </li>
  {% else %}
  <li class="step">Add your first payday!</li>
  {% endif %}
</ul>  
{% endif %}

{% if payday_exists %}
<br>
<div class="flex justify-center space-x-10">

    <div class="stats shadow">
      <div class="stat">
        <div class="stat-title">Net Worth</div>
        <div class="stat-value">{{ user.userpreferences.currency_symbol }} {{ last_net_worth.net_worth|floatformat:2|intcomma }}</div>
        <div class="stat-desc">{{ last_net_worth.perc_diff_with_last_month }}% compared to last month</div>
      </div>
    </div>

    <div class="stats shadow">
      <div class="stat">
        <div class="stat-title">Savings</div>
        <div class="stat-value">{{ user.userpreferences.currency_symbol }} {{ last_net_worth.total_savings|floatformat:2|intcomma }}</div>
        <div class="stat-desc">{{ last_net_worth.perc_diff_savings }}% compared to last month</div>
      </div>
    </div>

    <div class="stats shadow">
        <div class="stat">
          <div class="stat-title">Investments</div>
          <div class="stat-value">{{ user.userpreferences.currency_symbol }} {{ total_investments|floatformat:2|intcomma }}</div>
          <div class="stat-desc">{{ last_net_worth.perc_diff_investments }}% compared to last month</div>
        </div>
      </div>

      <div class="stats shadow">
        <div class="stat">
          <div class="stat-title">Pension</div>
          <div class="stat-value">{{ user.userpreferences.currency_symbol }} {{ total_pensions|floatformat:2|intcomma }}</div>
          <div class="stat-desc">{{ last_net_worth.perc_diff_pensions }}% compared to last month</div>
        </div>
      </div>

      <div class="stats shadow">
        <div class="stat">
          <div class="stat-title">PAC</div>
          <div class="stat-value">{{ user.userpreferences.currency_symbol }} {{ pac.amount|floatformat:2|intcomma }}</div>
          <div class="stat-desc"></div>
        </div>
      </div>
</div>  
<br>
<!-- Charts  -->
<div class="flex items-start justify-between">

  <style>
    #myPieChart {
      width: 450px !important; /* Adjust to your desired width */
      height: 450px !important; /* Adjust to your desired height */
    }
  </style>
    
  <div class="flex flex-col items-center w-1/2">
    <canvas id="netWorthChart" width="800" height="400">{{ graph_data|json_script:"graph-data" }}</canvas> 
    <canvas id="savingsChart" width="800" height="400">{{ graph_data|json_script:"graph-data" }}</canvas>  
  </div>

  <div class="w-1/2">    
    <canvas id="investmentsChart" width="800" height="400">{{ graph_data|json_script:"graph-data" }}</canvas>
    <canvas id="expensesChart" width="800" height="400">{{ graph_data|json_script:"graph-data" }}</canvas> 
  </div>  

</div>

<!-- Charts  -->
<div class="flex items-start justify-between">
    <div class="flex flex-col w-1/2">
      <div class="overflow-x-auto">
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Net Worth</th>
              <th>Savings</th>
              <th>Investments</th>
              <th>Pensions</th>
            </tr>
          </thead>
          {% for net_worth in net_worths %}
          <tbody>
            <!-- row 1 -->
            <tr>
              <th>{{ net_worth.payday.payday_date|date:"M-Y" }}</th>
              <td>{{ user.userpreferences.currency_symbol }} {{ net_worth.net_worth|floatformat:2|intcomma }}</td>
              <td>{{ user.userpreferences.currency_symbol }} {{ net_worth.total_savings|floatformat:2|intcomma }}</td>
              <td>{{ user.userpreferences.currency_symbol }} {{ net_worth.total_investments|floatformat:2|intcomma }}</td>
              <td>{{ user.userpreferences.currency_symbol }} {{ net_worth.total_pension|floatformat:2|intcomma }}</td>
              
            </tr>
          </tbody>
          {% endfor %}
        </table>
      </div>
    </div>

  
  <div class="flex flex-col items-center w-1/2">
    <canvas id="myPieChart" width="200" height="200">{{ graph_data|json_script:"graph-data" }}</canvas>
  </div>  

</div>
{% else %}
<br>
<form id="first_time_buttons" method="POST" action="{% url 'first_time_buttons' %}"> <!-- To be removed -->
  <div class="flex flex-col items-center justify-center">
    <div class="flex flex-col items-center w-full max-w-xs mb-4">
      {% csrf_token %}

      {% if not steps_completed.add_bank %}
      <a href="{% url 'banks' %}" class="btn btn-primary w-full h-12 mb-2">Add a Bank</a><br>
      {% endif %}

      {% if not steps_completed.add_broker %}
      <a href="{% url 'brokers' %}" class="btn btn-primary w-full h-12 mb-2">Add a Broker</a><br>
      {% endif %}

      {% if not steps_completed.add_fixed_cost %}
          <a href="{% url 'fixed_costs' %}" class="btn btn-primary w-full h-12 mb-2">Add a Fixed Cost</a><br>
      {% endif %}

      {% if not steps_completed.add_investment %}
          <a href="{% url 'investments' %}" class="btn btn-primary w-full h-12 mb-2">Add an Investment</a><br>
      {% endif %}

      {% if not steps_completed.add_categories %}
          <a href="{% url 'categories' %}" class="btn btn-primary w-full h-12 mb-2">Add Categories</a><br>
      {% endif %}
    </div>
  </div>
</form>

{% endif %}
    

<script>
  // Get the data passed from Django
  const graphData = JSON.parse(document.getElementById('graph-data').textContent);
  
  // Extract data for net_worth chart
  const labels = graphData.dates;  // X-axis (dates)
  const dataValues = graphData.net_worth_values;  // Y-axis (net worth values)
  // Extract data for savings chart
  const savingsValues = graphData.savings_values;  // Y-axis (savings values)
  // Extract data for savings chart
  const investmentsValues = graphData.investments_values;  // Y-axis (investments values)
  // Extract data for savings chart
  const expensesValues = graphData.expenses_values;  // Y-axis (expenses values)  
  // Extract data for pie chart
  const savings = graphData.savings; 
  const investments = graphData.investments;
  const pension = graphData.pensions;
  const pac = graphData.pac;
  const note = graphData.net_worth_notes;

// Create net_worth chart
const ctx = document.getElementById('netWorthChart').getContext('2d');
const netWorthChart = new Chart(ctx, {
    type: 'line', // Line chart
    data: {
        labels: labels,  
        datasets: [{
            label: 'Net Worth (£)',
            data: dataValues,  
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderWidth: 2,
            tooltip: {
                callbacks: {
                    label: function(tooltipItem) {
                        const index = tooltipItem.dataIndex;
                        const note = graphData.net_worth_notes ? graphData.net_worth_notes[index] : '';
                        return note ? `${tooltipItem.raw} - ${note}` : tooltipItem.raw;
                    }
                }
            }
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: true,
                position: 'top',
            },
        },
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Date',
                },
            },
            y: {
                title: {
                    display: true,
                    text: 'Net Worth (£)',
                },
                beginAtZero: true,
            },
        },
    }
});

  // Create net_worth chart
  const ctx_1 = document.getElementById('savingsChart').getContext('2d');
  const savingsChart = new Chart(ctx_1, {
      type: 'line', // Line chart
      data: {
          labels: labels,
          datasets: [{
              label: 'Savings (£)',
              data: savingsValues,
              borderColor: 'rgba(255, 159, 64, 1)',
              backgroundColor: 'rgba(255, 159, 64, 0.2)',
              borderWidth: 2,
          }]
      },
      options: {
          responsive: true,
          plugins: {
              legend: {
                  display: true,
                  position: 'top',
              },
          },
          scales: {
              x: {
                  title: {
                      display: true,
                      text: 'Date',
                  },
              },
              y: {
                  title: {
                      display: true,
                      text: 'Savings (£)',
                  },
                  beginAtZero: true,
              },
          },
      }
  });

  // Create net_worth chart
  const ctx_2 = document.getElementById('investmentsChart').getContext('2d');
  const investmentsChart = new Chart(ctx_2, {
      type: 'line', // Line chart
      data: {
          labels: labels,
          datasets: [{
              label: 'Investments (£)',
              data: investmentsValues,
              borderColor: 'rgba(153, 102, 255, 1)',
              backgroundColor: 'rgba(153, 102, 255, 0.2)',
              borderWidth: 2,
          }]
      },
      options: {
          responsive: true,
          plugins: {
              legend: {
                  display: true,
                  position: 'top',
              },
          },
          scales: {
              x: {
                  title: {
                      display: true,
                      text: 'Date',
                  },
              },
              y: {
                  title: {
                      display: true,
                      text: 'Investments (£)',
                  },
                  beginAtZero: true,
              },
          },
      }
  });

  // Create net_worth chart
  const ctx_3 = document.getElementById('expensesChart').getContext('2d');
  const expensesChart = new Chart(ctx_3, {
      type: 'line', // Line chart
      data: {
          labels: labels,
          datasets: [{
              label: 'Expenses (£)',
              data: expensesValues,
              borderColor: 'rgba(255, 99, 132, 1)',
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              borderWidth: 2,
          }]
      },
      options: {
          responsive: true,
          plugins: {
              legend: {
                  display: true,
                  position: 'top',
              },
          },
          scales: {
              x: {
                  title: {
                      display: true,
                      text: 'Date',
                  },
              },
              y: {
                  title: {
                      display: true,
                      text: 'Expenses (£)',
                  },
                  beginAtZero: true,
              },
          },
      }
  });

// Pie chart
const ctx_4 = document.getElementById('myPieChart').getContext('2d');
const myPieChart = new Chart(ctx_4, {
    type: 'pie',
    data: {
        labels: ['Savings', 'Investments', 'PAC', 'Pension'],
        datasets: [{
            label: 'Amount',
            data: [savings, investments, pac, pension],
            backgroundColor: ['#003366', '#5C6BC0', '#388E3C', '#FFB300'],
            borderColor: ['black', 'black', 'black', 'black'],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true
    }
});
</script>

{% endblock %}